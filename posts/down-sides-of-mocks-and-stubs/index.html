<!doctype html><html lang=en><head><title>The Downsides of Excessive Mocks and Stubs in Unit Testing · Bruno Hensel</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Bruno Hensel"><meta name=description content="The Downsides of Excessive Mocks and Stubs in Unit Testing Link to heading As commonly known, unit testing is a crucial part of software development. The use of mocks and stubs has become standard practice to isolate components and ensure reliable tests (London School). However, it&rsquo;s imperative to recognize the fragility and potential pitfalls associated with excessive mock and stub usage.
Clarifying Mocks and Stubs: Link to heading Before delving into the drawbacks, let&rsquo;s clarify the terms &ldquo;mock&rdquo; and &ldquo;stub."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="The Downsides of Excessive Mocks and Stubs in Unit Testing"><meta name=twitter:description content="The Downsides of Excessive Mocks and Stubs in Unit Testing Link to heading As commonly known, unit testing is a crucial part of software development. The use of mocks and stubs has become standard practice to isolate components and ensure reliable tests (London School). However, it&rsquo;s imperative to recognize the fragility and potential pitfalls associated with excessive mock and stub usage.
Clarifying Mocks and Stubs: Link to heading Before delving into the drawbacks, let&rsquo;s clarify the terms &ldquo;mock&rdquo; and &ldquo;stub."><meta property="og:title" content="The Downsides of Excessive Mocks and Stubs in Unit Testing"><meta property="og:description" content="The Downsides of Excessive Mocks and Stubs in Unit Testing Link to heading As commonly known, unit testing is a crucial part of software development. The use of mocks and stubs has become standard practice to isolate components and ensure reliable tests (London School). However, it&rsquo;s imperative to recognize the fragility and potential pitfalls associated with excessive mock and stub usage.
Clarifying Mocks and Stubs: Link to heading Before delving into the drawbacks, let&rsquo;s clarify the terms &ldquo;mock&rdquo; and &ldquo;stub."><meta property="og:type" content="article"><meta property="og:url" content="https://www.brunohensel.dev/posts/down-sides-of-mocks-and-stubs/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-19T08:09:57+02:00"><meta property="article:modified_time" content="2023-08-19T08:09:57+02:00"><link rel=canonical href=https://www.brunohensel.dev/posts/down-sides-of-mocks-and-stubs/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-dark"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Bruno Hensel</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://www.brunohensel.dev/posts/down-sides-of-mocks-and-stubs/>The Downsides of Excessive Mocks and Stubs in Unit Testing</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-08-19T08:09:57+02:00>Aug 19, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div></div></header><div class=post-content><h2 id=the-downsides-of-excessive-mocks-and-stubs-in-unit-testing>The Downsides of Excessive Mocks and Stubs in Unit Testing
<a class=heading-link href=#the-downsides-of-excessive-mocks-and-stubs-in-unit-testing><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>As commonly known, unit testing is a crucial part of software development. The use of mocks and stubs has become standard practice to isolate components and ensure reliable tests (London School). However, it&rsquo;s imperative to recognize the fragility and potential pitfalls associated with excessive mock and stub usage.</p><h2 id=clarifying-mocks-and-stubs>Clarifying Mocks and Stubs:
<a class=heading-link href=#clarifying-mocks-and-stubs><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Before delving into the drawbacks, let&rsquo;s clarify the terms &ldquo;mock&rdquo; and &ldquo;stub.&rdquo; A mock is typically created with the assistance of a mocking framework (e.g., Mockito) and helps emulate and examine interactions between the System Under Test (SUT) and its dependencies. On the other hand, stubs are constructs that assist with interactions between the SUT and its dependencies to provide specific data.</p><h2 id=the-fragility-of-excessive-mocks-and-stubs>The Fragility of Excessive Mocks and Stubs:
<a class=heading-link href=#the-fragility-of-excessive-mocks-and-stubs><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At many workplaces, mocking libraries are used in virtually every unit test, leading to repetitive setup code. This can hinder scalability and create maintenance overhead as developers keep repeating the same configurations.</p><p>Moreover, the ease of constructing the SUT using mocking libraries might tempt developers to overlook the importance of a good design. For instance violating the Interface Segregation Principle makes very painfull to create a Fake (another type of test doubles, I will cover it in next posts) of it, on the other hand, it&rsquo;s a breeze to do that with a mocking library.</p><h2 id=complex-test-setup-and-review-challenges>Complex Test Setup and Review Challenges:
<a class=heading-link href=#complex-test-setup-and-review-challenges><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Test files often end up with extensive setup code, making it challenging for reviewers to grasp the test&rsquo;s intent if they are unfamiliar with the production code. The back-and-forth between test and production files can be time-consuming and inefficient. With that much setup in the way, it&rsquo;s hard to be as declarative as possible.</p><h2 id=fragile-interaction-testing>Fragile Interaction Testing:
<a class=heading-link href=#fragile-interaction-testing><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Interaction testing, which verifies whether specific dependencies were invoked, can couple tests tightly to implementation details. This results in brittle tests that require frequent updates whenever implementation details change, undermining the value of automation.</p><p><em>If a set of tests needs to be manually tweaked by engineers for each change, calling it an &ldquo;automated test suite&rdquo; is a bit of a stretch!</em> (Software Engineering at Google, p.223)</p><h2 id=incomplete-test-coverage>Incomplete Test Coverage:
<a class=heading-link href=#incomplete-test-coverage><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Over-reliance on interaction testing can lead to incomplete test coverage, as it focuses solely on verifying dependency interactions while potentially neglecting the behavior of the SUT itself.</p><h2 id=risks-of-stubbing-external-functions>Risks of Stubbing External Functions:
<a class=heading-link href=#risks-of-stubbing-external-functions><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Stubbing functions from external sources that are not owned or fully understood can lead to a mismatch between the stubbed behavior and the actual implementation. This poses a risk of breaking present or future preconditions, invariants, or postconditions in the external function.</p><p>Example Illustration:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Example of Stubbing a Function - MyClassTest
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Calculator</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>fun</span> <span style=color:#d2a8ff;font-weight:700>sum</span>(a: Int, b: Int): Int {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> abs(a + b) <span style=color:#8b949e;font-style:italic>// always returns a positive integer
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>MyClassTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>val</span> <span style=color:#79c0ff>calc</span>: Calculator = mock()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>val</span> <span style=color:#79c0ff>sut</span>: MyClass = MyClass(calc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>fun</span> <span style=color:#d2a8ff;font-weight:700>testAdd</span>() {
</span></span><span style=display:flex><span>        whenever(calc.sum(<span style=color:#a5d6ff>1</span>, -<span style=color:#a5d6ff>3</span>)).doReturn(<span style=color:#a5d6ff>2</span>) <span style=color:#8b949e;font-style:italic>// Stubbing the sum function
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        assertEquals(sut.getNewValue(<span style=color:#a5d6ff>1</span>, -<span style=color:#a5d6ff>3</span>), <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The test passes. But by stubbing the function <code>sum</code> we are forced to kind of duplicate the details of the contract, and there is no way to guarantee that it has or will have fidelity to the real implementation. Just by reading the signature of the <code>sum</code> method, there is no guaratee that this function always returns positive integers. More about depending on <a href=https://www.hyrumslaw.com/ class=external-link target=_blank rel=noopener>implicit interface behavior</a></p><p>Times went by and the owner of the <code>Calc#sum</code> method decides to change the postcondition of always returning positive integers to now also returns negative values. The owner updates their own test suite and runs the entire test suite of the project (assuming that all code belongs to the same repo). The worst happened, <code>MyClassTest#test_add</code> still passes!, giving a false feeling of safety. If always have a positive number is expected but not explicitly promessed by the contract, you should&rsquo;ve written a test for it (The Beyoncé Rule).</p><h2 id=conclusion>Conclusion:
<a class=heading-link href=#conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Excessive use of mocks and stubs in unit testing can introduce fragility, hinder maintainability, and lead to incomplete test coverage. Being aware of these downsides is crucial for fostering a robust and reliable testing strategy. In the next blog post, we will explore guidelines and best practices for using test doubles more effectively, ensuring high-quality test suites that stand the test of time.</p><p><a href=https://github.com/mockito/mockito/wiki/How-to-write-good-tests#dont-mock-everything-its-an-anti-pattern class=external-link target=_blank rel=noopener>if everything is mocked, are we really testing the production code?</a></p><h2 id=sources>Sources
<a class=heading-link href=#sources><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Software Engineering at Google (<a href=https://abseil.io/resources/swe-book class=external-link target=_blank rel=noopener>currently available to read online</a>)</li><li>Efective Software Testing</li><li>Unit Testing (Principles, Practices, and Patterns)</li><li>This post was posted originally in <a href=https://vinted.engineering/2023/10/02/mocking-framework-downside/ class=external-link target=_blank rel=noopener>Vinted Engineering Blog</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Bruno Hensel
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ED4JJJVD8G"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ED4JJJVD8G")</script></body></html>